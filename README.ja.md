# メロウクイズラリー 開発メモ

このドキュメントは、最新コミット時点のアプリ構成と挙動を日本語で整理したものです。フロントエンドを改修するときの導線や、ランキング共有に関わるポイントをまとめています。

## アプリの構成
- 主要ファイルは次の3つです。
  - `index.html`: 画面レイアウトとテンプレート定義。スタート・クイズ・結果の3ビューに分かれます。
  - `styles.css`: パステル調のライト/ダークテーマ、カードUI、テーブルなど共通スタイル。
  - `app.js`: クイズの進行、ランキング同期、リンク共有などのロジック一式。
- 追加ライブラリは使わず、ブラウザ標準APIのみで動作します。

## 画面フロー
1. **スタートビュー** (`#startView`)
   - プレイヤー名と出題数を入力して開始。
   - 右側に現在のランキングを表示し、共有用URLをコピー/最新化できます。
2. **クイズビュー** (`#quizView`)
   - 問題文、選択肢、残り時間バーを表示。
   - 正解で+10点、不正解で-5点(下限0)。タイムアップ時は自動で次の問題へ。
3. **結果ビュー** (`#resultView`)
   - 今回のスコア・正解数・経過時間を表示。
   - セッションのランキングテーブルと共有URLを再掲。
   - 「同じランキングでもう一度」から連続プレイ可能。

ビュー切り替えは `app.js` の `showView` 関数で制御されます。

## 問題データの取得
- 初回起動時に指定サイトのHTMLを `fetch` → `DOMParser` で解析し、問題/選択肢/正解を抽出します。
- ネットワーク不通や解析失敗時は `app.js` 内のフォールバック問題24問を利用します。
- 取得済みの問題セットは `localStorage` にキャッシュされ、再読み込み時も再利用されます。

## ランキングと共有
- ランキングごとにユニークID(ハッシュ)を生成し、URLのフラグメント `#r=...` として共有します。
- 同じハッシュを持つページにアクセスした端末は、`localStorage` に保存されたスコアボードを自動的に同期します。
- 「最新ランキングを読み込む」ボタンで、ハッシュやストレージ更新を即座に反映。
- 結果ビューではCSV書き出し、共有リンクコピー、ランキング表示をまとめて操作できます。

## テーマ切替
- ヘッダー右上の🌙ボタンでライト/ダークをトグル。
- OSのダークモードを初期値に採用し、ユーザー操作後は `localStorage` の `mellow.quiz.theme` に保存します。

## 主なローカルストレージキー
| キー名 | 内容 |
| --- | --- |
| `mellow.quiz.questions` | 解析済みクイズ問題のキャッシュ |
| `mellow.quiz.theme` | テーマのユーザー選択(Light/Dark) |
| `mellow.quiz.sessions` | ランキングごとのスコア履歴(複数セッションを配列で保持) |

## トラブルシューティング
- **DOM要素が見つからない**: マージ失敗などで `index.html` のテンプレートが欠けると初期化時にガードが働き、アラート表示で停止します。最新ファイルを取得し直してください。
- **リンク共有後に順位が更新されない**: `localStorage` 共有が行われるのは同一ブラウザ内の別タブのみです。別端末では共有URLを開き直し「最新ランキングを読み込む」ボタンを押すと最新データを反映できます。

## 開発フローのヒント
- `node --check app.js` で構文チェックができます。
- レイアウト確認は `python -m http.server` などのローカルサーバー経由で行うと共有リンクが実際のURLになり挙動を再現しやすくなります。

このドキュメントはコード変更のたびに追記・更新することを想定しています。変更内容をまとめる際は、上記の構成をベースに箇条書きで記録すると差分把握がしやすくなります。
