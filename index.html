<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„ÇØ„Ç§„Ç∫„Éê„Éà„É´„Ç¢„É™„Éº„Éä</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üéâ</text></svg>">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f2f5ff;
      --bg-dark: #111425;
      --panel: rgba(255, 255, 255, 0.82);
      --panel-dark: rgba(18, 21, 41, 0.82);
      --text: #283046;
      --text-dark: #f9fbff;
      --accent: #ff8fb1;
      --accent-2: #a48bff;
      --accent-3: #7ce5ff;
      --muted: #6c7a99;
      --muted-dark: #a8b5ff;
      --shadow: 0 18px 45px rgba(82, 94, 136, 0.25);
      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-md: 16px;
      --font-heading: "Zen Maru Gothic", "Nunito", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      --font-body: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Inter", system-ui, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #10132b;
        --panel: rgba(21, 25, 46, 0.92);
        --text: #f6f6ff;
        --muted: #a6b4ff;
        --shadow: 0 18px 55px rgba(6, 8, 25, 0.55);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-body);
      color: var(--text);
      background: var(--bg);
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 420px;
      height: 420px;
      filter: blur(120px);
      opacity: 0.55;
      z-index: -2;
    }

    body::before {
      background: linear-gradient(135deg, rgba(255, 143, 177, 0.95), rgba(164, 139, 255, 0.9));
      top: -140px;
      left: -140px;
    }

    body::after {
      background: linear-gradient(135deg, rgba(124, 229, 255, 0.85), rgba(255, 215, 160, 0.85));
      bottom: -160px;
      right: -120px;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: clamp(20px, 4vw, 48px) clamp(18px, 4vw, 48px) 80px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header.app-header {
      text-align: center;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.3));
      border-radius: var(--radius-xl);
      padding: clamp(18px, 4vw, 32px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }

    header.app-header h1 {
      margin: 0;
      font-family: var(--font-heading);
      font-size: clamp(26px, 5vw, 44px);
      letter-spacing: 0.04em;
    }

    header.app-header p {
      margin: 12px auto 0;
      max-width: 520px;
      line-height: 1.7;
      color: var(--muted);
      font-size: clamp(14px, 2.8vw, 16px);
    }

    .panel {
      background: var(--panel);
      backdrop-filter: blur(18px);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      padding: clamp(20px, 4vw, 36px);
      display: none;
      flex-direction: column;
      gap: clamp(16px, 3vw, 28px);
    }

    .panel.active {
      display: flex;
    }

    .panel h2 {
      margin: 0;
      font-family: var(--font-heading);
      font-size: clamp(20px, 4vw, 30px);
    }

    .panel p.lead {
      margin: 0;
      line-height: 1.8;
      color: var(--muted);
    }

    .player-form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .player-form input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 2px solid rgba(120, 140, 200, 0.22);
      background: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      outline: none;
    }

    .player-form input[type="text"]:focus {
      border-color: rgba(164, 139, 255, 0.65);
      box-shadow: 0 0 0 4px rgba(164, 139, 255, 0.25);
    }

    .btn {
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      letter-spacing: 0.02em;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #fff;
      box-shadow: 0 14px 30px rgba(175, 150, 255, 0.4);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.55);
      color: var(--text);
      border: 1px solid rgba(132, 148, 190, 0.28);
      box-shadow: none;
    }

    .btn.buzz {
      width: 100%;
      font-size: clamp(15px, 3.4vw, 18px);
      background: linear-gradient(120deg, rgba(255, 143, 177, 0.92), rgba(255, 195, 113, 0.92));
      color: #fff;
      border-radius: 999px;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(107, 135, 255, 0.32);
    }

    ul.player-list,
    ul.score-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }

    ul.player-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.65);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      border: 1px solid rgba(164, 139, 255, 0.24);
      font-weight: 600;
    }

    ul.player-list li button {
      background: none;
      border: none;
      color: rgba(244, 92, 129, 0.88);
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 999px;
      transition: background 0.2s ease;
    }

    ul.player-list li button:hover {
      background: rgba(244, 92, 129, 0.12);
    }

    .score-grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .score-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    .score-card {
      position: relative;
      padding: 18px;
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(164, 139, 255, 0.28);
      box-shadow: 0 10px 26px rgba(122, 144, 210, 0.24);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    .score-card.active {
      border: 2px solid rgba(255, 143, 177, 0.85);
      box-shadow: 0 18px 32px rgba(255, 143, 177, 0.35);
      transform: translateY(-4px);
    }

    .score-card .rank {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 12px;
      font-weight: 700;
      color: rgba(94, 104, 152, 0.8);
      background: rgba(255, 255, 255, 0.65);
      padding: 4px 10px;
      border-radius: 999px;
    }

    .score-card .name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .score-card .score {
      font-size: 32px;
      font-weight: 800;
      color: rgba(100, 117, 255, 0.95);
    }

    .score-card .meta {
      margin-top: 8px;
      font-size: 13px;
      color: rgba(90, 101, 145, 0.75);
    }

    .question-area {
      display: grid;
      gap: 18px;
    }

    .question-bubble {
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-lg);
      padding: 18px 20px;
      border: 1px solid rgba(148, 168, 230, 0.28);
      font-size: clamp(18px, 4.2vw, 26px);
      line-height: 1.6;
      font-weight: 700;
    }

    .question-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      color: rgba(83, 96, 133, 0.88);
      font-size: 14px;
    }

    .timer-shell {
      position: relative;
      flex: 1;
      min-width: 140px;
      background: rgba(124, 229, 255, 0.3);
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }

    .timer-bar {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 100%;
      background: linear-gradient(120deg, rgba(255, 143, 177, 0.9), rgba(124, 229, 255, 0.9));
      transform-origin: left center;
      transition: transform 0.2s linear;
    }

    .choices {
      display: grid;
      gap: 14px;
    }

    @media (min-width: 640px) {
      .choices {
        grid-template-columns: 1fr 1fr;
      }
    }

    .choice-btn {
      border-radius: var(--radius-md);
      border: 2px solid transparent;
      padding: clamp(14px, 4vw, 18px);
      text-align: left;
      background: rgba(255, 255, 255, 0.78);
      font-size: clamp(15px, 3.6vw, 18px);
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
      position: relative;
      min-height: 64px;
    }

    .choice-btn:hover:not(.disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(123, 142, 210, 0.3);
    }

    .choice-btn.disabled {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .choice-btn.correct {
      border-color: rgba(46, 204, 113, 0.9);
      box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.2);
    }

    .choice-btn.wrong {
      border-color: rgba(231, 76, 60, 0.85);
      box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.2);
    }

    .choice-btn span.index {
      position: absolute;
      top: 14px;
      right: 18px;
      font-size: 13px;
      color: rgba(90, 101, 145, 0.75);
      font-weight: 700;
    }

    .buzz-grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .buzz-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
    }

    .toast {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: rgba(124, 229, 255, 0.3);
      border: 1px solid rgba(124, 229, 255, 0.48);
      color: rgba(44, 59, 88, 0.95);
      font-weight: 600;
    }

    .toast.negative {
      background: rgba(255, 177, 177, 0.28);
      border-color: rgba(255, 122, 122, 0.48);
      color: rgba(132, 39, 39, 0.92);
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
      overflow: hidden;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(164, 139, 255, 0.32);
    }

    .result-table thead {
      background: rgba(164, 139, 255, 0.18);
      font-weight: 700;
    }

    .result-table th,
    .result-table td {
      padding: 14px 16px;
      text-align: left;
    }

    .result-table tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.55);
    }

    .result-table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.8);
    }

    .subtle {
      font-size: 13px;
      color: rgba(90, 101, 145, 0.72);
    }

    .ranking-board {
      display: grid;
      gap: 12px;
    }

    .ranking-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(124, 229, 255, 0.32);
      font-weight: 600;
      font-size: 15px;
    }

    .ranking-entry span small {
      display: block;
      font-size: 12px;
      color: rgba(90, 101, 145, 0.65);
      font-weight: 500;
    }

    .empty-state {
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(124, 229, 255, 0.45);
      background: rgba(255, 255, 255, 0.55);
      color: rgba(90, 101, 145, 0.75);
      text-align: center;
      font-size: 14px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: rgba(90, 101, 145, 0.65);
      padding-bottom: 32px;
    }

    a {
      color: inherit;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <h1>„ÇØ„Ç§„Ç∫„Éê„Éà„É´„Ç¢„É™„Éº„Éä</h1>
      <p>Âèã„Å†„Å°„ÇÑÂÆ∂Êóè„Å®Âêå„ÅòÁ´ØÊú´„ÅßÊó©Êäº„ÅóÂØæÊà¶ÔºÅ„É©„É≥„Ç≠„É≥„Ç∞Ê©üËÉΩ„ÅßÁõõ„Çä‰∏ä„Åå„Çç„ÅÜ„ÄÇÂïèÈ°å„ÅØ<a href="http://www.chukai.ne.jp/~shintaku/hayaoshi/haya00.htm" target="_blank" rel="noopener noreferrer">Êñ∞ÂÆÖÂ∫É‰∫å„Åï„Çì„ÅÆÊó©Êäº„Åó„ÇØ„Ç§„Ç∫ÈõÜ</a>„Åã„ÇâÂºïÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
    </header>

    <section id="screen-setup" class="panel active" aria-labelledby="setup-heading">
      <div>
        <h2 id="setup-heading">„Éó„É¨„Ç§„É§„Éº„ÇíÁôªÈå≤</h2>
        <p class="lead">2‰∫∫‰ª•‰∏ä„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ„Åô„Çã„Å®ÂØæÊà¶„Çí„Çπ„Çø„Éº„Éà„Åß„Åç„Åæ„Åô„ÄÇ„Çπ„Éû„Éõ„Åß„ÇÇPC„Åß„ÇÇÈÅä„Åπ„Çã„É¨„Çπ„Éù„É≥„Ç∑„Éñ„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„Åô„ÄÇ</p>
      </div>

      <form class="player-form" id="player-form">
        <input type="text" id="player-name" placeholder="„Éó„É¨„Ç§„É§„ÉºÂêç" maxlength="12" autocomplete="off" required />
        <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
        <button type="button" class="btn btn-ghost" id="btn-clear">ÂÖ®Âì°„É™„Çª„ÉÉ„Éà</button>
      </form>

      <ul class="player-list" id="player-list" aria-live="polite"></ul>

      <div>
        <label class="lead" for="question-count">Âá∫È°åÊï∞</label>
        <select id="question-count" style="margin-top: 8px; padding: 12px 14px; border-radius: var(--radius-md); border: 2px solid rgba(164, 139, 255, 0.32); background: rgba(255, 255, 255, 0.85); font-size: 15px;">
          <option value="5">5Âïè</option>
          <option value="10" selected>10Âïè</option>
          <option value="15">15Âïè</option>
        </select>
      </div>

      <button class="btn btn-primary" id="btn-start" disabled>ÂØæÊà¶„Çπ„Çø„Éº„ÉàÔºÅ</button>

      <div>
        <h3 style="margin: 0 0 8px; font-family: var(--font-heading);">Ê≠¥‰ª£„É©„É≥„Ç≠„É≥„Ç∞</h3>
        <div id="global-ranking" class="ranking-board" aria-live="polite"></div>
      </div>
    </section>

    <section id="screen-game" class="panel" aria-live="polite">
      <div class="question-area">
        <div class="question-meta">
          <span id="question-progress">1 / 10</span>
          <div class="timer-shell" aria-hidden="true">
            <div class="timer-bar" id="timer-bar"></div>
          </div>
          <span id="countdown" aria-label="ÊÆã„ÇäÊôÇÈñì">20s</span>
        </div>
        <div class="question-bubble" id="question-text">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
        <div class="choices" id="choice-list"></div>
        <div class="toast" id="toast">ÂõûÁ≠î„Åô„Çã‰∫∫„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ</div>
      </div>

      <div>
        <h3 style="margin: 0; font-family: var(--font-heading);">Ëß£Á≠îÊ®©„Çí„Å®„Çã</h3>
        <div class="buzz-grid" id="buzz-list"></div>
      </div>

      <div class="score-grid" id="score-grid"></div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-ghost" id="btn-pass">„Åì„ÅÆÂïèÈ°å„Çí„Çπ„Ç≠„ÉÉ„Éó</button>
        <button class="btn btn-primary" id="btn-next" disabled>Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
      </div>
    </section>

    <section id="screen-result" class="panel" aria-labelledby="result-heading">
      <div>
        <h2 id="result-heading">ÊúÄÁµÇÁµêÊûú</h2>
        <p class="lead" id="result-summary">„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ</p>
      </div>

      <div class="score-grid" id="result-score-grid"></div>

      <table class="result-table" aria-describedby="result-heading">
        <thead>
          <tr>
            <th>È†Ü‰Ωç</th>
            <th>„Éó„É¨„Ç§„É§„Éº</th>
            <th>„Çπ„Ç≥„Ç¢</th>
            <th>Ê≠£Ëß£</th>
            <th>Ë™§Á≠î</th>
          </tr>
        </thead>
        <tbody id="result-table"></tbody>
      </table>

      <div>
        <h3 style="margin: 0 0 8px; font-family: var(--font-heading);">Ê≠¥‰ª£„É©„É≥„Ç≠„É≥„Ç∞Ôºà„Éà„ÉÉ„Éó10Ôºâ</h3>
        <div id="result-ranking" class="ranking-board"></div>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-ghost" id="btn-back">„Çπ„Çø„Éº„ÉàÁîªÈù¢„Å∏Êàª„Çã</button>
        <button class="btn btn-primary" id="btn-rematch">Âêå„Åò„É°„É≥„Éê„Éº„Åß„ÇÇ„ÅÜ‰∏ÄÊà¶</button>
      </div>
    </section>

    <footer>
      &copy; 2024 Quiz Battle Arena ¬∑ ÂïèÈ°å„ÇΩ„Éº„Çπ: <a href="http://www.chukai.ne.jp/~shintaku/hayaoshi/haya00.htm" target="_blank" rel="noopener">Êñ∞ÂÆÖÂ∫É‰∫å„Åï„Çì„ÅÆÊó©Êäº„Åó„ÇØ„Ç§„Ç∫</a>
    </footer>
  </div>

  <template id="player-chip-template">
    <li>
      <span class="name"></span>
      <button type="button" title="ÂâäÈô§">√ó</button>
    </li>
  </template>

  <template id="score-card-template">
    <div class="score-card">
      <span class="rank">1‰Ωç</span>
      <div class="name">Player</div>
      <div class="score">0 pt</div>
      <div class="meta">Ê≠£Ëß£ 0 / Ë™§Á≠î 0</div>
    </div>
  </template>

  <template id="buzz-card-template">
    <div>
      <div class="score-card">
        <div class="name">Player</div>
        <div class="meta">„Çø„ÉÉ„Éó„ÅßËß£Á≠îÊ®©</div>
      </div>
      <button class="btn buzz">ÂõûÁ≠î„Éú„Çø„É≥</button>
    </div>
  </template>

  <template id="ranking-entry-template">
    <div class="ranking-entry">
      <span>1‰Ωç ‚Äî 0pt<small>„Éó„É¨„Ç§„É§„Éº</small></span>
      <span class="subtle">Ê≠£Ëß£ 0</span>
    </div>
  </template>

  <script>
    const PROXY_URL = "https://r.jina.ai/http://www.chukai.ne.jp/~shintaku/hayaoshi/haya00.htm";
    const LOCAL_STORAGE_KEY = "quiz-battle-arena-ranking";
    const QUESTION_TIME = 25; // seconds

    // „Ç™„Éï„É©„Ç§„É≥ÊôÇ„Å´Âà©Áî®„Åô„Çã‰∫àÂÇô„Çª„ÉÉ„ÉàÔºàÊñ∞ÂÆÖÂ∫É‰∫å„Åï„Çì„ÅÆÊó©Êäº„Åó„ÇØ„Ç§„Ç∫ÈõÜ„Çà„ÇäÊäúÁ≤ãÔºâ
    const FALLBACK_QUESTIONS = [
      { id: "A-01", question: "ÂõΩÈöõÁöÑ„Å™Ëà™Á©∫‰ø°Âè∑„Åß„ÄéSOS„Äè„ÇíË°®„Åô„É¢„Éº„É´„Çπ‰ø°Âè∑„ÅØ„ÄÅ„Éâ„ÉÉ„Éà„Å®„ÉÄ„ÉÉ„Ç∑„É•„Çí„Å©„ÅÜÁµÑ„ÅøÂêà„Çè„Åõ„Åü„ÇÇ„ÅÆÔºü", choices: ["„Éª„Éª„Éª„Éº„Éº„Éº„Éª„Éª„Éª", "„Éª„Éª„Éº„Éª„Éº„Éª„Éª", "„Éº„Éº„Éº„Éª„Éª„Éª„Éº„Éº„Éº", "„Éª„Éª„Éº„Éº„Éº„Éª„Éª"], answer: 0 },
      { id: "A-02", question: "Á´•Ë¨°„Äé„Åµ„Åò„ÅÆÂ±±„Äè„ÅÆÊ≠å„ÅÑÂá∫„Åó„ÅØ„Äé„ÅÇ„Åü„Åæ„ÇíÈõ≤„ÅÆ‰∏ä„Å´Âá∫„Åó„Äè„Åß„Åô„Åå„ÄÅ2Ë°åÁõÆ„Å´Á∂ö„ÅèÊ≠åË©û„ÅØÔºü", choices: ["ÂõõÊñπ„ÅÆÂ±±„ÇíË¶ã„Åä„Çç„Åó„Å¶", "ÂõõÊñπ„ÅÆÊµ∑„ÇíË¶ã„Åä„Çç„Åó„Å¶", "ÂõõÊñπ„ÅÆÁî∫„ÇíË¶ã„Åä„Çç„Åó„Å¶", "ÂõõÊñπ„ÅÆÁ©∫„ÇíË¶ã„Åä„Çç„Åó„Å¶"], answer: 0 },
      { id: "A-03", question: "Êó•Êú¨„ÅÆÈÉΩÈÅìÂ∫úÁúå„ÅßÂîØ‰∏Ä„ÄÅÁúå„ÅÆÂêçÂâç„Å®ÁúåÂ∫ÅÊâÄÂú®Âú∞„ÅÆÂêçÂâç„ÅåÁï∞„Å™„Çã„ÅÆ„ÅØ„Å©„ÅìÔºü", choices: ["ÂåóÊµ∑ÈÅì", "Â±±Ê¢®Áúå", "Ê≤ñÁ∏ÑÁúå", "Áü≥Â∑ùÁúå"], answer: 3 },
      { id: "A-04", question: "ÂÆÆÊ≤¢Ë≥¢Ê≤ª„ÅÆÁ´•Ë©±„ÄéÈäÄÊ≤≥ÈâÑÈÅì„ÅÆÂ§ú„Äè„Åß„ÄÅ‰∏ª‰∫∫ÂÖ¨„Ç∏„Éß„Éê„É≥„Éã„ÅÆË¶™Âèã„ÅÆÂêçÂâç„ÅØÔºü", choices: ["„Ç´„É†„Éë„Éç„É´„É©", "„Éù„É©„Éº„Éé", "„Éì„Ç¢„É≥„Ç´", "„Ç∏„Éß„Çª„Éï„Ç£„Éº„Éå"], answer: 0 },
      { id: "A-05", question: "‰∫îÂÜÜÁ°¨Ë≤®„ÅÆÁ©¥„ÅÆÁõ¥ÂæÑ„ÅØÁ¥Ñ5„Éü„É™„Åß„Åô„Åå„ÄÅÁ°¨Ë≤®„ÅÆÂ§ñÂæÑ„ÅØ„ÅÑ„Åè„Å§Ôºü", choices: ["16mm", "18mm", "20mm", "22mm"], answer: 3 },
      { id: "A-06", question: "Áâ©ÁêÜ„ÅÆÂçò‰Ωç„Åß„ÄÅÈõªÊµÅ„ÅÆÂº∑„Åï„ÇíË°®„ÅôÂõΩÈöõÂçò‰Ωç„ÅØÔºü", choices: ["„Éú„É´„Éà", "„Ç¢„É≥„Éö„Ç¢", "„ÉØ„ÉÉ„Éà", "„Ç™„Éº„É†"], answer: 1 },
      { id: "A-07", question: "JISË¶èÊ†º„ÅÆA4Áî®Á¥ô„ÅÆÈï∑Ëæ∫„ÅØ297mm„Åß„Åô„Åå„ÄÅÁü≠Ëæ∫„ÅØÔºü", choices: ["190mm", "210mm", "220mm", "240mm"], answer: 1 },
      { id: "A-08", question: "Ê∞óË±°Â∫Å„ÅÆÁî®Ë™û„Åß„ÄéÁåõÊöëÊó•„Äè„Å®„ÅØÊúÄÈ´òÊ∞óÊ∏©„Åå‰ΩïÂ∫¶‰ª•‰∏ä„ÅÆÊó•Ôºü", choices: ["33‚ÑÉ", "35‚ÑÉ", "37‚ÑÉ", "40‚ÑÉ"], answer: 1 },
      { id: "A-09", question: "Êó•Êú¨„ÅÆÁ•ùÊó•„Åß„ÄÅÊØéÂπ¥5Êúà3Êó•„Å´„ÅÇ„Åü„Çã„ÅÆ„ÅØÔºü", choices: ["„Åø„Å©„Çä„ÅÆÊó•", "„Åì„Å©„ÇÇ„ÅÆÊó•", "ÊÜ≤Ê≥ïË®òÂøµÊó•", "Âª∫ÂõΩË®òÂøµ„ÅÆÊó•"], answer: 2 },
      { id: "A-10", question: "‰∏ñÁïå‰∏âÂ§ßÊñôÁêÜ„ÅÆ„ÅÜ„Å°„ÄÅ‰∏≠ÂõΩÊñôÁêÜ„Å®„Å®„ÇÇ„Å´Êï∞„Åà„Çâ„Çå„Çã„ÅÆ„ÅØ„Éï„É©„É≥„ÇπÊñôÁêÜ„Å®„Å©„ÅìÔºü", choices: ["„Ç§„Çø„É™„Ç¢ÊñôÁêÜ", "„Éà„É´„Ç≥ÊñôÁêÜ", "„Çπ„Éö„Ç§„É≥ÊñôÁêÜ", "„Ç§„É≥„ÉâÊñôÁêÜ"], answer: 1 },
      { id: "A-11", question: "„Ç™„É™„É≥„Éî„ÉÉ„ÇØÊÜ≤Á´†„ÅßÂÆö„ÇÅ„Çâ„Çå„Åü‰∫îËº™„ÅÆËâ≤„ÅØ„ÄÅÈùí„ÉªÈªÑ„ÉªÈªí„ÉªÁ∑ë„Å®‰ΩïËâ≤Ôºü", choices: ["Ëµ§", "ÁôΩ", "Á¥´", "Èáë"], answer: 0 },
      { id: "A-12", question: "‰∏ñÁïåÈÅ∫Áî£„ÉªÂß´Ë∑ØÂüé„ÅÆÂà•Âêç„ÅØÔºü", choices: ["ÁôΩÈ∑∫Âüé", "È∂¥„É∂Âüé", "ÁÉèÂüé", "‰∫ÄÂüé"], answer: 0 },
      { id: "A-13", question: "Êó•Êú¨„ÅÆÈÉµ‰æøÁï™Âè∑„ÅØ‰ΩïÊ°ÅÔºü", choices: ["5Ê°Å", "6Ê°Å", "7Ê°Å", "8Ê°Å"], answer: 2 },
      { id: "A-14", question: "Á´•Ë¨°„Äé„Åµ„Çã„Åï„Å®„Äè„Åß„ÄÅ„Åµ„Çã„Åï„Å®„Å´ÊÆã„Åó„Å¶„Åç„Åü„ÅÆ„ÅØ„ÄéÁà∂ÊØç„Äè„Å®‰ΩïÔºü", choices: ["Âèã„Å†„Å°", "ÂÖÑÂºü", "Â∞è„Åï„Å™ÂÆ∂", "Â±±„ÅÆÂ∞èÂ∑ù"], answer: 3 },
      { id: "A-15", question: "1Êúà1Êó•„Åã„ÇâÊï∞„Åà„Å¶„Å°„Çá„ÅÜ„Å©100Êó•ÁõÆ„ÅØÈÄöÂ∏∏‰ΩïÊúà‰ΩïÊó•Ôºü", choices: ["4Êúà9Êó•", "4Êúà10Êó•", "4Êúà11Êó•", "4Êúà12Êó•"], answer: 1 },
      { id: "A-16", question: "Ê±üÊà∏ÊôÇ‰ª£„ÅÆ‰∫îË°óÈÅì„ÅÆ‰∏Ä„Å§„Åß„ÄÅÊ±üÊà∏„Å®‰∫¨ÈÉΩ„ÇíÁµê„Çì„Åß„ÅÑ„ÅüÈÅì„ÅØÔºü", choices: ["Áî≤Â∑ûË°óÈÅì", "Êó•ÂÖâË°óÈÅì", "‰∏≠Â±±ÈÅì", "Êù±Êµ∑ÈÅì"], answer: 3 },
      { id: "A-17", question: "Á´•Ë©±„ÄéÊ°ÉÂ§™ÈÉé„Äè„Åß„ÄÅÊ°ÉÂ§™ÈÉé„Åå„Åä„Å∞„ÅÇ„Åï„Çì„Åã„Çâ„ÇÇ„Çâ„ÅÜÂõ£Â≠ê„ÅØ‰ΩïÂõ£Â≠êÔºü", choices: ["„ÅÇ„Çì„ÅìÂõ£Â≠ê", "„Åç„Å≥Âõ£Â≠ê", "„Åø„Åü„Çâ„ÅóÂõ£Â≠ê", "ËçâÂõ£Â≠ê"], answer: 1 },
      { id: "A-18", question: "Ëµ§ÈÅìÁõ¥‰∏ã„Å´‰ΩçÁΩÆ„Åô„ÇãÂõΩ„ÅÆ„ÅÜ„Å°„ÄÅ„Ç¢„Éï„É™„Ç´Â§ßÈô∏„Å´„ÅÇ„Çã„ÅÆ„ÅØ„Å©„ÇåÔºü", choices: ["„Ç±„Éã„Ç¢", "„Ç®„ÇØ„Ç¢„Éâ„É´", "„Éû„É¨„Éº„Ç∑„Ç¢", "„Éö„É´„Éº"], answer: 0 },
      { id: "A-19", question: "Á´•Ë¨°„ÄéÊò•„ÅåÊù•„Åü„Äè„Åß„Äé„Å©„Åì„Å´Êù•„Åü„Äè„Å®Ê≠å„Çè„Çå„Çã„ÅÆ„ÅØ„ÄéÈáé„Å´„Äè„Å®„ÄéÂ±±„Å´„Äè„Å®„Å©„ÅìÔºü", choices: ["Áî∫„Å´", "Èáå„Å´", "Á©∫„Å´", "Â∑ù„Å´"], answer: 1 },
      { id: "A-20", question: "Ê∞∑„ÅåÊ∞¥„Å´ÊµÆ„Åã„Å∂„ÅÆ„ÅØ„ÄÅÊ∞¥„Å®ÊØî„Åπ„Å¶Ê∞∑„ÅÆÂØÜÂ∫¶„Åå„Å©„ÅÜ„Å™„Å£„Å¶„ÅÑ„Çã„Åã„ÇâÔºü", choices: ["Â§ß„Åç„ÅÑ", "Â∞è„Åï„ÅÑ", "Âêå„Åò", "Ê∏©Â∫¶„Å´„Çà„Çã"], answer: 1 },
      { id: "A-21", question: "‰∫åÂçÅÂõõÁØÄÊ∞ó„Åß„ÄÅ1Âπ¥„ÅÆÂßã„Åæ„Çä„Å´‰ΩçÁΩÆ„Å•„Åë„Çâ„Çå„Çã„ÅÆ„ÅØÔºü", choices: ["ÂïìËüÑ", "Â§ßÂØí", "Á´ãÊò•", "Êò•ÂàÜ"], answer: 2 },
      { id: "A-22", question: "Êò†Áîª„Äé„Å®„Å™„Çä„ÅÆ„Éà„Éà„É≠„Äè„Åß„ÄÅ„Çµ„ÉÑ„Ç≠„Å®„É°„Ç§„Åå‰Ωè„ÇÄÊùë„ÅÆÂêçÁß∞„ÅØÔºü", choices: ["ÊùæÈÉ∑", "‰∏ÉÂõΩÂ±±", "Áã≠Â±±", "ÊùæÈÉ∑Êùë"], answer: 1 },
      { id: "A-23", question: "Êó•Êú¨‰∏âÊôØ„Å´Êï∞„Åà„Çâ„Çå„Çã„ÅÆ„ÅØ„ÄÅÊùæÂ≥∂„ÉªÂ§©Ê©ãÁ´ã„Å®„Å©„ÅìÔºü", choices: ["ÂÆÆÂ≥∂", "Âé≥Â≥∂", "ÂÖºÂÖ≠Âúí", "Ë¢ãÁî∞"], answer: 0 },
      { id: "A-24", question: "Ê∫êÊ∞èÁâ©Ë™û„ÅÆ‰ΩúËÄÖ„ÅØÔºü", choices: ["Á¥´ÂºèÈÉ®", "Ê∏ÖÂ∞ëÁ¥çË®Ä", "‰∏éË¨ùÈáéÊô∂Â≠ê", "ÂíåÊ≥âÂºèÈÉ®"], answer: 0 }
    ];

    const state = {
      players: [],
      questions: [],
      currentIndex: 0,
      answeringId: null,
      lock: false,
      countdown: QUESTION_TIME,
      timerId: null,
    };

    const refs = {
      screens: {
        setup: document.getElementById("screen-setup"),
        game: document.getElementById("screen-game"),
        result: document.getElementById("screen-result"),
      },
      playerForm: document.getElementById("player-form"),
      playerName: document.getElementById("player-name"),
      playerList: document.getElementById("player-list"),
      btnClear: document.getElementById("btn-clear"),
      btnStart: document.getElementById("btn-start"),
      questionCount: document.getElementById("question-count"),
      globalRanking: document.getElementById("global-ranking"),
      game: {
        progress: document.getElementById("question-progress"),
        text: document.getElementById("question-text"),
        choices: document.getElementById("choice-list"),
        toast: document.getElementById("toast"),
        buzzList: document.getElementById("buzz-list"),
        scoreGrid: document.getElementById("score-grid"),
        btnNext: document.getElementById("btn-next"),
        btnPass: document.getElementById("btn-pass"),
        timerBar: document.getElementById("timer-bar"),
        countdown: document.getElementById("countdown"),
      },
      result: {
        summary: document.getElementById("result-summary"),
        scoreGrid: document.getElementById("result-score-grid"),
        table: document.getElementById("result-table"),
        ranking: document.getElementById("result-ranking"),
        btnBack: document.getElementById("btn-back"),
        btnRematch: document.getElementById("btn-rematch"),
      },
    };

    const templates = {
      playerChip: document.getElementById("player-chip-template"),
      scoreCard: document.getElementById("score-card-template"),
      buzzCard: document.getElementById("buzz-card-template"),
      rankingEntry: document.getElementById("ranking-entry-template"),
    };

    function uid() {
      return Math.random().toString(36).slice(2, 9);
    }

    function switchScreen(screen) {
      Object.values(refs.screens).forEach((el) => el.classList.remove("active"));
      screen.classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderPlayerList() {
      refs.playerList.innerHTML = "";
      if (!state.players.length) {
        const li = document.createElement("li");
        li.className = "empty-state";
        li.textContent = "„Åæ„Å†„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        refs.playerList.appendChild(li);
      } else {
        state.players.forEach((player) => {
          const node = templates.playerChip.content.firstElementChild.cloneNode(true);
          node.querySelector(".name").textContent = player.name;
          node.querySelector("button").addEventListener("click", () => removePlayer(player.id));
          refs.playerList.appendChild(node);
        });
      }
      refs.btnStart.disabled = state.players.length < 2;
    }

    function removePlayer(id) {
      state.players = state.players.filter((p) => p.id !== id);
      renderPlayerList();
    }

    function addPlayer(name) {
      const trimmed = name.trim();
      if (!trimmed) return;
      if (state.players.some((p) => p.name === trimmed)) {
        notify("Âêå„ÅòÂêçÂâç„ÅÆ„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åô„ÄÇÂà•„ÅÆÂêçÂâç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", true);
        return;
      }
      state.players.push({
        id: uid(),
        name: trimmed,
        score: 0,
        correct: 0,
        wrong: 0,
      });
      renderPlayerList();
      refs.playerName.value = "";
      refs.playerName.focus();
    }

    function notify(message, negative = false) {
      refs.game.toast.textContent = message;
      refs.game.toast.classList.toggle("negative", negative);
    }

    async function loadQuestions() {
      try {
        const response = await fetch(PROXY_URL, { cache: "no-store" });
        if (!response.ok) throw new Error("fetch failed");
        const html = await response.text();
        const parsed = parseQuestionsFromHtml(html);
        if (parsed.length) {
          console.info(`Loaded ${parsed.length} questions from source.`);
          return parsed;
        }
        console.warn("Parsed question count is zero, using fallback");
        return FALLBACK_QUESTIONS.slice();
      } catch (err) {
        console.warn("Failed to load questions from network, fallback used", err);
        return FALLBACK_QUESTIONS.slice();
      }
    }

    function parseQuestionsFromHtml(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const nodes = Array.from(doc.querySelectorAll("body font, body td, body p"));
      const questions = [];
      let current = null;
      nodes.forEach((node) => {
        const text = node.textContent.replace(/\s+/g, " ").trim();
        if (!text) return;
        const qMatch = text.match(/^Q\s*(\d+)\s*(.*)$/i);
        if (qMatch) {
          if (current && current.choices.filter(Boolean).length === 4) {
            questions.push(current);
          }
          current = {
            id: `Q${qMatch[1]}`,
            question: qMatch[2].replace(/^[\.:Ôºö]/, "").trim(),
            choices: [],
            answer: 0,
          };
          return;
        }
        if (!current) return;
        const choiceMatch = text.match(/^[Ôºà(]?([1-4ÔºëÔºíÔºìÔºî])[)Ôºâ.Ôºé:Ôºö]\s*(.*)$/);
        if (choiceMatch) {
          const index = "ÔºëÔºíÔºìÔºî".indexOf(choiceMatch[1]);
          const normalizedIndex = index >= 0 ? index : Number(choiceMatch[1]) - 1;
          current.choices[normalizedIndex] = choiceMatch[2].trim();
          return;
        }
        const answerMatch = text.match(/Ê≠£Ëß£[Ôºö: ]+([1-4ÔºëÔºíÔºìÔºî])/);
        if (answerMatch) {
          const index = "ÔºëÔºíÔºìÔºî".indexOf(answerMatch[1]);
          current.answer = index >= 0 ? index : Number(answerMatch[1]) - 1;
        }
      });
      if (current && current.choices.filter(Boolean).length === 4) {
        questions.push(current);
      }
      return questions
        .map((q) => ({
          ...q,
          choices: q.choices.map((choice) => (choice || "").trim()),
        }))
        .filter((q) => Array.isArray(q.choices) && q.choices.length === 4 && q.choices.every(Boolean));
    }

    function shuffle(array) {
      const copy = array.slice();
      for (let i = copy.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function selectQuestions(all, count) {
      const unique = all
        .map((q) => ({
          ...q,
          question: (q.question || "").trim(),
          choices: Array.isArray(q.choices) ? q.choices.map((c) => (c || "").trim()) : [],
        }))
        .filter((q) => q.question && q.choices.length === 4 && q.choices.every(Boolean));
      const selected = shuffle(unique).slice(0, count);
      if (selected.length < count && FALLBACK_QUESTIONS.length) {
        const extra = shuffle(FALLBACK_QUESTIONS).slice(0, count - selected.length);
        return selected.concat(extra);
      }
      return selected;
    }

    function renderBuzzers() {
      refs.game.buzzList.innerHTML = "";
      state.players.forEach((player) => {
        const wrapper = document.createElement("div");
        wrapper.className = "buzz-item";
        const card = templates.buzzCard.content.firstElementChild.cloneNode(true);
        const cardBody = card.querySelector(".score-card");
        cardBody.querySelector(".name").textContent = player.name;
        cardBody.querySelector(".meta").textContent = "„Çø„ÉÉ„Éó„ÅßËß£Á≠îÊ®©";
        const button = card.querySelector(".btn.buzz");
        const activate = () => {
          if (state.lock) return;
          state.answeringId = player.id;
          highlightActivePlayer();
          notify(`${player.name}„Åï„Çì„ÅåËß£Á≠î„Åó„Åæ„ÅôÔºÅ`);
        };
        cardBody.addEventListener("click", activate);
        button.addEventListener("click", activate);
        wrapper.appendChild(card);
        refs.game.buzzList.appendChild(wrapper);
      });
    }

    function highlightActivePlayer() {
      const cards = Array.from(refs.game.scoreGrid.querySelectorAll(".score-card"));
      cards.forEach((card) => card.classList.remove("active"));
      const active = cards.find((card) => card.dataset.id === state.answeringId);
      if (active) active.classList.add("active");
    }

    function renderScoreboard(container, players, activeId = state.answeringId) {
      container.innerHTML = "";
      if (!players.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "„Åæ„Å†„Çπ„Ç≥„Ç¢„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
        container.appendChild(empty);
        return;
      }
      const sorted = players.slice().sort((a, b) => b.score - a.score || b.correct - a.correct || a.name.localeCompare(b.name));
      sorted.forEach((player, index) => {
        const node = templates.scoreCard.content.firstElementChild.cloneNode(true);
        node.dataset.id = player.id;
        node.querySelector(".rank").textContent = `${index + 1}‰Ωç`;
        node.querySelector(".name").textContent = player.name;
        node.querySelector(".score").textContent = `${player.score} pt`;
        node.querySelector(".meta").textContent = `Ê≠£Ëß£ ${player.correct} / Ë™§Á≠î ${player.wrong}`;
        if (player.id === activeId) {
          node.classList.add("active");
        }
        container.appendChild(node);
      });
    }

    function renderChoices(question) {
      refs.game.choices.innerHTML = "";
      question.choices.forEach((choice, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "choice-btn";
        button.innerHTML = `<span>${choice}</span><span class="index">${index + 1}</span>`;
        button.addEventListener("click", () => handleChoice(index));
        refs.game.choices.appendChild(button);
      });
    }

    function setChoicesDisabled(disabled = true) {
      refs.game.choices.querySelectorAll(".choice-btn").forEach((button) => {
        button.classList.toggle("disabled", disabled);
        button.disabled = disabled;
      });
    }

    function handleChoice(index) {
      if (state.lock) return;
      if (!state.answeringId) {
        notify("ÂÖà„Å´Ëß£Á≠î„Åô„Çã„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ", true);
        return;
      }
      const question = state.questions[state.currentIndex];
      const player = state.players.find((p) => p.id === state.answeringId);
      if (!player) {
        notify("„Éó„É¨„Ç§„É§„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ", true);
        return;
      }
      state.lock = true;
      stopTimer();
      const correctIndex = question.answer;
      const buttons = Array.from(refs.game.choices.querySelectorAll(".choice-btn"));
      buttons.forEach((button, idx) => {
        button.classList.toggle("correct", idx === correctIndex);
        if (idx === index && idx !== correctIndex) {
          button.classList.add("wrong");
        }
        button.disabled = true;
        button.classList.add("disabled");
      });
      if (index === correctIndex) {
        player.score += 10;
        player.correct += 1;
        notify(`${player.name}„Åï„Çì„ÄÅÊ≠£Ëß£„Åß„ÅôÔºÅ +10pt`);
      } else {
        player.score = Math.max(0, player.score - 5);
        player.wrong += 1;
        notify(`${player.name}„Åï„Çì„ÄÅÊÆãÂøµÔºÅ -5pt (Ê≠£Ëß£„ÅØ${correctIndex + 1}Áï™)`, true);
      }
      renderScoreboard(refs.game.scoreGrid, state.players);
      highlightActivePlayer();
      refs.game.btnNext.disabled = false;
    }

    function loadQuestion(index) {
      const question = state.questions[index];
      if (!question) return;
      state.answeringId = null;
      state.lock = false;
      refs.game.btnNext.disabled = true;
      refs.game.text.textContent = question.question;
      refs.game.progress.textContent = `${index + 1} / ${state.questions.length}`;
      renderChoices(question);
      renderScoreboard(refs.game.scoreGrid, state.players);
      highlightActivePlayer();
      setChoicesDisabled(false);
      notify("ÂõûÁ≠î„Åô„Çã‰∫∫„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ");
      state.countdown = QUESTION_TIME;
      refs.game.countdown.textContent = `${state.countdown}s`;
      refs.game.timerBar.style.transform = "scaleX(1)";
      startTimer();
    }

    function startTimer() {
      stopTimer();
      const total = QUESTION_TIME;
      state.timerId = setInterval(() => {
        state.countdown -= 1;
        if (state.countdown <= 0) {
          refs.game.countdown.textContent = "0s";
          refs.game.timerBar.style.transform = "scaleX(0)";
          stopTimer();
          handleTimeout();
        } else {
          refs.game.countdown.textContent = `${state.countdown}s`;
          const ratio = state.countdown / total;
          refs.game.timerBar.style.transform = `scaleX(${Math.max(ratio, 0)})`;
        }
      }, 1000);
    }

    function handleTimeout() {
      if (state.lock) return;
      state.lock = true;
      notify("„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ„Éù„Ç§„É≥„Éà„ÅØÂÖ•„Çä„Åæ„Åõ„Çì„ÄÇ", true);
      setChoicesDisabled(true);
      refs.game.btnNext.disabled = false;
    }

    function stopTimer() {
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    function nextQuestion() {
      stopTimer();
      state.currentIndex += 1;
      if (state.currentIndex >= state.questions.length) {
        finishGame();
        return;
      }
      loadQuestion(state.currentIndex);
    }

    function skipQuestion() {
      if (state.lock) {
        nextQuestion();
        return;
      }
      notify("„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ", true);
      stopTimer();
      refs.game.btnNext.disabled = false;
      setChoicesDisabled(true);
      state.lock = true;
    }

    function loadRanking() {
      try {
        const stored = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || "[]");
        return Array.isArray(stored) ? stored : [];
      } catch (err) {
        console.warn("Failed to parse ranking storage", err);
        return [];
      }
    }

    function saveRanking(entries) {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(entries));
    }

    function updateRankingBoard(target, entries) {
      target.innerHTML = "";
      if (!entries.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂØæÊà¶„Åó„Å¶„É©„É≥„Ç≠„É≥„Ç∞„Çí‰Ωú„Çç„ÅÜÔºÅ";
        target.appendChild(empty);
        return;
      }
      entries.forEach((entry, index) => {
        const node = templates.rankingEntry.content.firstElementChild.cloneNode(true);
        const label = node.querySelector("span");
        label.innerHTML = `${index + 1}‰Ωç ‚Äî ${entry.score}pt<small>${entry.name}</small>`;
        node.querySelector(".subtle").textContent = `Ê≠£Ëß£ ${entry.correct} (${new Date(entry.timestamp).toLocaleDateString()})`;
        target.appendChild(node);
      });
    }

    function persistRanking(players, totalQuestions) {
      const entries = loadRanking();
      players.forEach((player) => {
        entries.push({
          name: player.name,
          score: player.score,
          correct: player.correct,
          wrong: player.wrong,
          total: totalQuestions,
          timestamp: Date.now(),
        });
      });
      entries.sort((a, b) => b.score - a.score || b.correct - a.correct || a.name.localeCompare(b.name));
      const trimmed = entries.slice(0, 10);
      saveRanking(trimmed);
      return trimmed;
    }

    function finishGame() {
      stopTimer();
      const sorted = state.players.slice().sort((a, b) => b.score - a.score || b.correct - a.correct || a.name.localeCompare(b.name));
      const top = sorted[0];
      const summary = top ? `${top.name}„Åï„Çì„Åå ${top.score}pt „ÅßÂÑ™ÂãùÔºÅ „Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ` : "ÂØæÊà¶„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ";
      refs.result.summary.textContent = summary;
      renderScoreboard(refs.result.scoreGrid, sorted, null);
      refs.result.table.innerHTML = "";
      sorted.forEach((player, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${index + 1}</td><td>${player.name}</td><td>${player.score}</td><td>${player.correct}</td><td>${player.wrong}</td>`;
        refs.result.table.appendChild(tr);
      });
      const ranking = persistRanking(sorted, state.questions.length);
      updateRankingBoard(refs.result.ranking, ranking);
      updateRankingBoard(refs.globalRanking, ranking);
      switchScreen(refs.screens.result);
    }

    function resetGameState() {
      stopTimer();
      state.questions = [];
      state.currentIndex = 0;
      state.answeringId = null;
      state.lock = false;
      state.countdown = QUESTION_TIME;
    }

    async function startGame() {
      resetGameState();
      const count = Number(refs.questionCount.value) || 10;
      const allQuestions = await loadQuestions();
      state.questions = selectQuestions(allQuestions, count);
      if (!state.questions.length) {
        notify("ÂïèÈ°å„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ", true);
        return;
      }
      state.players = state.players.map((p) => ({ ...p, score: 0, correct: 0, wrong: 0 }));
      renderBuzzers();
      renderScoreboard(refs.game.scoreGrid, state.players);
      refs.game.btnNext.disabled = true;
      refs.game.btnPass.disabled = false;
      switchScreen(refs.screens.game);
      loadQuestion(0);
    }

    function backToSetup() {
      resetGameState();
      renderPlayerList();
      updateRankingBoard(refs.globalRanking, loadRanking());
      switchScreen(refs.screens.setup);
    }

    function bootstrap() {
      renderPlayerList();
      updateRankingBoard(refs.globalRanking, loadRanking());

      refs.playerForm.addEventListener("submit", (event) => {
        event.preventDefault();
        addPlayer(refs.playerName.value);
      });

      refs.btnClear.addEventListener("click", () => {
        state.players = [];
        renderPlayerList();
      });

      refs.btnStart.addEventListener("click", () => {
        if (state.players.length < 2) {
          notify("„Éó„É¨„Ç§„É§„Éº„ÅØ2‰∫∫‰ª•‰∏äÂøÖË¶Å„Åß„Åô„ÄÇ", true);
          return;
        }
        startGame();
      });

      refs.game.btnNext.addEventListener("click", nextQuestion);
      refs.game.btnPass.addEventListener("click", skipQuestion);

      refs.result.btnBack.addEventListener("click", backToSetup);
      refs.result.btnRematch.addEventListener("click", () => {
        if (!state.players.length) {
          backToSetup();
          return;
        }
        startGame();
      });

      document.addEventListener("keydown", (event) => {
        if (refs.screens.game.classList.contains("active")) {
          const number = parseInt(event.key, 10);
          if (!Number.isNaN(number) && number >= 1 && number <= 4) {
            handleChoice(number - 1);
          }
        }
      });
    }

    document.addEventListener("DOMContentLoaded", bootstrap);
  </script>
</body>
</html>
